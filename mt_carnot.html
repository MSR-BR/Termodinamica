<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Simulador – Ciclo de Carnot (gás ideal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a;background:#f8fafc}
    header{padding:14px 12px 0 12px;text-align:center}
    header h1{margin:0;font-size:1.6rem}
    header p{margin:.25rem 0 0 0;color:#334155}
    header .credits{margin:.25rem 0 12px 0;color:#475569;font-size:.95rem}

    .app{display:grid;grid-template-columns:360px 320px 1fr;gap:14px;padding:14px}
    @media (max-width:1100px){.app{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:10px}
    .card h3{margin:4px 0 8px 0}
    .procLabel{margin:6px auto 10px auto;padding:6px 10px;border-radius:10px;background:#eef2ff;color:#1e293b;font-weight:700;font-size:.95rem;display:inline-block}

    /* Cena do cilindro */
    :root{ --cil-alt:320px; --cil-larg:220px; --pist-alt:22px; }
    .scene{display:flex;flex-direction:column;align-items:center}
    .sceneHeader{display:flex;align-items:center;justify-content:center}
    .res{width:86px;height:var(--cil-alt);border:3px solid #334155;background:#fff7e6;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;margin:0 6px}
    .res span{font-weight:700;color:#334155}
    .cil{position:relative;width:var(--cil-larg);height:var(--cil-alt);border:3px solid #334155;border-radius:12px;background:#ffffff;overflow:hidden;margin:0 8px}
    .cil.isolado{background:repeating-linear-gradient(45deg,#f1f5f9 0 10px,#e2e8f0 10px 20px)}
    .gas{position:absolute;left:0;width:100%;background:linear-gradient(#bae6fd,#e2e8f0);bottom:0}
    .pist{position:absolute;left:0;width:100%;height:var(--pist-alt);background:linear-gradient(#475569,#94a3b8);border-bottom:1px solid #0f172a22;z-index:1}
    .arrowH,.arrowV{position:absolute}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .ctrl{background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;padding:8px}
    .ctrl h4{margin:0 0 6px 0}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0}
    .row label{width:110px;color:#334155}
    .row input[type="number"]{width:110px}
    button{appearance:none;background:#0ea5e9;color:#fff;border:none;border-radius:10px;padding:7px 10px;font-weight:700;cursor:pointer}
    button.secondary{background:#64748b}

    .kv{display:grid;grid-template-columns:auto 1fr;gap:6px;font-variant-numeric:tabular-nums}
    .kv div:nth-child(odd){color:#334155}

    .plotWrap{position:relative}
    #plotST{width:100%;height:360px;border-radius:12px;background:#fff;border:1px solid #e2e8f0;display:block}
  </style>
</head>
<body>
  <header>
    <h1>Ciclo de Carnot — máquina térmica (gás ideal)</h1>
    <p>Condição do ciclo (gás ideal): <b>V₂/V₁ = V₃/V₄</b>. Entradas mínimas: <i>n</i>, T<sub>H</sub>, T<sub>C</sub>, V<sub>1</sub>, r = V<sub>2</sub>/V<sub>1</sub> e γ.</p>
    <p class="credits">Desenvolvido por <b>Mario Reis</b> – Instituto de Física, Universidade Federal Fluminense (UFF)<br>
      <a href="mailto:marioreis@id.uff.br">marioreis@id.uff.br</a> · <a href="http://profmarioreis.wordpress.com" target="_blank">profmarioreis.wordpress.com</a><br>
      Versão 1.0 – 21 de outubro de 2025</p>
  </header>

  <div class="app">
    <!-- Coluna 1: CENA + CONTROLES -->
    <div class="card">
      <div class="scene">
        <div id="procMachine" class="procLabel">Processo atual: pronto (estado 1)</div>
        <div class="sceneHeader">
          <div class="res" id="resC"><span>Reservatório</span><span>T<sub>C</sub></span><span id="labTC">400 K</span></div>
          <div class="cil" id="cil">
            <div class="gas" id="gas"></div>
            <div class="pist" id="pist"></div>
            <!-- setas calor/trabalho -->
            <div class="arrowH" id="aQ" style="left:8px;bottom:10px;width:100px;height:40px">
              <svg viewBox="0 0 100 40" width="100" height="40">
                <line x1="0" y1="20" x2="100" y2="20" stroke="#dc2626" stroke-width="4" />
                <polygon points="90,10 90,30 100,20" fill="#dc2626" />
              </svg>
            </div>
            <div class="arrowV" id="aW" style="right:8px;bottom:8px;width:20px;height:50px">
              <svg viewBox="0 0 20 50" width="20" height="50">
                <line x1="10" y1="50" x2="10" y2="0" stroke="#2563eb" stroke-width="4" />
                <polygon points="5,15 15,15 10,0" fill="#2563eb" />
              </svg>
            </div>
          </div>
          <div class="res" id="resH"><span>Reservatório</span><span>T<sub>H</sub></span><span id="labTH">700 K</span></div>
        </div>
      </div>

      <div class="controls">
        <div class="ctrl" style="grid-column:1/3">
          <h4>Parâmetros mínimos</h4>
          <div class="row"><label>n (mol)</label><input id="nMol" type="number" value="2" step="0.1"></div>
          <div class="row"><label>T<sub>H</sub> (K)</label><input id="TH" type="number" value="700" step="1"></div>
          <div class="row"><label>T<sub>C</sub> (K)</label><input id="TC" type="number" value="400" step="1"></div>
          <div class="row"><label>V<sub>1</sub> (L)</label><input id="V1" type="number" value="8" step="0.1"></div>
          <div class="row"><label>r = V<sub>2</sub>/V<sub>1</sub></label><input id="r12" type="number" value="2.5" step="0.1" min="1"></div>
          <div class="row"><label>γ (adiabático)</label><input id="gamma" type="number" value="1.667" step="0.001"></div>
          <div class="row" style="justify-content:space-between">
            <button id="recalc">Recalcular</button>
            <div style="display:flex;gap:8px">
              <button id="play">▶︎ Play</button>
              <button id="pause" class="secondary">❚❚ Pause</button>
              <button id="step" class="secondary">➤ Step</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna 2: resultados -->
    <div class="card">
      <h3>Resultados</h3>
      <div class="kv" id="kv"></div>
      <hr>
      <div class="kv" id="detail"></div>
      <p style="margin-top:8px;color:#334155;font-size:.9rem">Convenção: ΔW>0 = trabalho <b>no</b> gás (compressão); ΔW<0 = trabalho <b>pelo</b> gás (expansão). Em isotérmico ideal, ΔU=0 ⇒ ΔQ = −ΔW.</p>
    </div>

    <!-- Coluna 3: S(T) -->
    <div class="card">
      <h3>Plano S×T (J/K × K) — Carnot</h3>
      <div id="procNow" class="procLabel">Processo atual: pronto (estado 1)</div>
      <div class="plotWrap">
        <canvas id="plotST"></canvas>
      </div>
    </div>
  </div>

  <script>
    // === util ===
    const R = 8.314462618; // J/mol/K
    const L2M3 = 1e-3;
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

    // === elementos ===
    const nEl = document.getElementById('nMol');
    const THEl = document.getElementById('TH');
    const TCEl = document.getElementById('TC');
    const V1El = document.getElementById('V1');
    const rEl = document.getElementById('r12');
    const gEl = document.getElementById('gamma');
    const recalcBtn = document.getElementById('recalc');

    const cil = document.getElementById('cil');
    const pist = document.getElementById('pist');
    const gas = document.getElementById('gas');
    const aQ = document.getElementById('aQ');
    const aW = document.getElementById('aW');

    const labTH = document.getElementById('labTH');
    const labTC = document.getElementById('labTC');

    const kv = document.getElementById('kv');
    const detail = document.getElementById('detail');

    const plot = document.getElementById('plotST');
    const ctx = plot.getContext('2d');

    const btnPlay = document.getElementById('play');
    const btnPause = document.getElementById('pause');
    const btnStep = document.getElementById('step');

    const procMachine = document.getElementById('procMachine');

    // === cena: mapa volume->posição do pistão ===
    const pistMinTop = 28, pistMaxTop = 220, pistAlt = 22; // px
    function pistTopFromV(V, Vmin, Vmax){
      const f = clamp((V-Vmin)/(Vmax-Vmin),0,1);
      return pistMaxTop - f*(pistMaxTop - pistMinTop);
    }

    // === estado do ciclo ===
    let S = null; // objeto de estado calculado
    let playing = false; let tAnim=0; let lastTime=0;
    let CUR = null; // cursor atual {T,S}

    function compute(){
      const n = +nEl.value; const TH = +THEl.value; const TC = +TCEl.value; const V1 = +V1El.value; const r = Math.max(1,+rEl.value); const gamma = +gEl.value;
      labTH.textContent = TH.toFixed(0)+" K"; labTC.textContent = TC.toFixed(0)+" K";

      // volumes via Carnot: V2/V1=r e V3/V4=r; adiabático: T V^{γ-1}=cte
      const V2 = r*V1;
      const V4 = V1 * Math.pow(TH/TC, 1/(gamma-1));
      const V3 = r*V4;

      // pressões (estados 1..4)
      const P1 = n*R*TH/(V1*L2M3);
      const P2 = n*R*TH/(V2*L2M3);
      const P3 = n*R*TC/(V3*L2M3);
      const P4 = n*R*TC/(V4*L2M3);

      // calores (isotérmicos)
      const QH = n*R*TH*Math.log(V2/V1); // >0
      const QC = n*R*TC*Math.log(V4/V3); // <0

      // trabalhos (isotérmicos; adiabáticos = ΔU)
      const C_v = R/(gamma-1); // usa γ
      const W21 = -QH;           // no gás
      const W43 = -QC;
      const W32 = n*C_v*(TC-TH); // adiabático (ΔU)
      const W14 = n*C_v*(TH-TC);
      const Wtot_no_gas = W21 + W32 + W43 + W14; // soma "no gás"

      const eta = 1 - TC/TH;

      // ΔS em cada isotérmica
      const dS21 = QH/TH; // +
      const dS43 = QC/TC; // -
      const S1 = 0, S2 = S1 + dS21, S3 = S2, S4 = S1;

      S = {n,TH,TC,V1,V2,V3,V4,P1,P2,P3,P4,QH,QC,W21,W32,W43,W14,Wtot_no_gas,eta,dS21,dS43,S1,S2,S3,S4,gamma};

      // UI resultados (6 casas, evita erro de arredondamento prematuro)
      kv.innerHTML = `
          <div>η (Carnot)</div><div><b>${eta.toFixed(6)}</b> = 1 − T<sub>C</sub>/T<sub>H</sub></div>
          <div>ΔQ<sub>H</sub> (1→2)</div><div><b>${QH.toFixed(6)}</b> J</div>
          <div>ΔQ<sub>C</sub> (3→4)</div><div><b>${QC.toFixed(6)}</b> J</div>
          <div>ΔW<sub>total</sub> (pelo gás)</div><div><b>${(-Wtot_no_gas).toFixed(6)}</b> J</div>
        `;

      detail.innerHTML = `
          <div>V1,V2,V3,V4</div><div>${V1.toFixed(6)} → ${V2.toFixed(6)} → ${V3.toFixed(6)} → ${V4.toFixed(6)} L</div>
          <div>P1..P4</div><div>${(P1/1000).toFixed(6)}, ${(P2/1000).toFixed(6)}, ${(P3/1000).toFixed(6)}, ${(P4/1000).toFixed(6)} kPa</div>
          <div>γ (adiabático)</div><div>${gamma.toFixed(6)} (usado em T V^{γ−1}=cte)</div>
          <div>ΔS (1→2)</div><div>${dS21.toFixed(6)} J/K</div>
          <div>ΔS (3→4)</div><div>${dS43.toFixed(6)} J/K</div>
        `;

      // reset cursores
      CUR = {T:TH, S:S1};
      updateLabels('idle');

      drawST();
      positionPiston(1);
    }

    function positionPiston(state, frac=0){
      if(!S) return;
      const {V1,V2,V3,V4} = S;
      const Vmin = Math.min(V1,V2,V3,V4), Vmax=Math.max(V1,V2,V3,V4);
      let V=V1;
      if(state===1){ V=V1; showHeat(false); }
      if(state==='12'){ V = V1*Math.pow(V2/V1, frac); showHeat(true, +1); updateLabels('12'); }
      if(state==='23'){ V = V2*Math.pow(V3/V2, frac); showHeat(false,true); updateLabels('23'); }
      if(state==='34'){ V = V3*Math.pow(V4/V3, frac); showHeat(true, -1); updateLabels('34'); }
      if(state==='41'){ V = V4*Math.pow(V1/V4, frac); showHeat(false,true); updateLabels('41'); }
      const top = pistTopFromV(V, Vmin, Vmax);
      pist.style.top = top + 'px';
      gas.style.top = (top + pistAlt) + 'px';
    }

    function showHeat(isIso, dir){
      aQ.style.display = isIso? 'block':'none';
      aW.style.display = 'block';
      if(isIso){ aQ.style.transform = (dir>0? 'scaleX(1)':'scaleX(-1)'); aW.style.transform = (dir>0? 'scaleY(1)':'scaleY(-1)'); }
      cil.classList.toggle('isolado', !isIso);
    }

    function updateLabels(seg){
      const map={ 'idle':'Processo atual: pronto (estado 1)', '12':'Processo atual: Expansão isotérmica (T=TH)', '23':'Processo atual: Expansão adiabática (isolado)', '34':'Processo atual: Compressão isotérmica (T=TC)', '41':'Processo atual: Compressão adiabática (isolado)' };
      const elG=document.getElementById('procNow'); if(elG) elG.textContent = map[seg]||map['idle'];
      const elM=document.getElementById('procMachine'); if(elM) elM.textContent = map[seg]||map['idle'];
    }

    // === S×T ===
    function drawST(){
      const rect = plot.getBoundingClientRect();
      let W = Math.max(480, Math.floor(rect.width||0));
      let H = Math.max(300, Math.floor(rect.height||0));
      if(!isFinite(W)||W<=0) W=800; if(!isFinite(H)||H<=0) H=360;
      plot.width=W; plot.height=H; ctx.clearRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
      if(!S) return;
      const {TH,TC,S1,S2} = S; const dS=S2-S1; const padS=0.3*Math.abs(dS||1);
      const Tmin=Math.min(TC,TH)*0.8, Tmax=Math.max(TC,TH)*1.2;
      const Smin=Math.min(S1,S2)-padS, Smax=Math.max(S1,S2)+padS;
      const x=T=>60+((T-Tmin)/(Tmax-Tmin))*(W-100); const y=S=>20+(1-(S-Smin)/(Smax-Smin))*(H-64);

      // grid + eixos
      ctx.strokeStyle='#e2e8f0'; for(let i=0;i<=8;i++){const xx=x(Tmin+(i/8)*(Tmax-Tmin)); ctx.beginPath(); ctx.moveTo(xx,20); ctx.lineTo(xx,H-44); ctx.stroke();}
      for(let i=0;i<=8;i++){const yy=y(Smin+(i/8)*(Smax-Smin)); ctx.beginPath(); ctx.moveTo(60,yy); ctx.lineTo(W-40,yy); ctx.stroke();}
      ctx.strokeStyle='#334155'; ctx.beginPath(); ctx.moveTo(60,20); ctx.lineTo(60,H-44); ctx.lineTo(W-40,H-44); ctx.stroke();
      ctx.fillStyle='#334155'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; for(let i=0;i<=8;i++){const T=Tmin+(i/8)*(Tmax-Tmin); ctx.fillText(Math.round(T), x(T), H-40);} ctx.textAlign='right'; ctx.textBaseline='middle'; for(let i=0;i<=8;i++){const s=Smin+(i/8)*(Smax-Smin); ctx.fillText(s.toFixed(2), 56, y(s));}

      // retângulo do Carnot + setas
      ctx.strokeStyle='#0f172a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x(TH), y(S1)); ctx.lineTo(x(TH), y(S2)); ctx.lineTo(x(TC), y(S2)); ctx.lineTo(x(TC), y(S1)); ctx.closePath(); ctx.stroke();
      drawArrow(x(TH), y(S1), x(TH), y(S2), '#ef4444');
      drawArrow(x(TH), y(S2), x(TC), y(S2), '#64748b');
      drawArrow(x(TC), y(S2), x(TC), y(S1), '#f59e0b');
      drawArrow(x(TC), y(S1), x(TH), y(S1), '#64748b');

      // cursor
      if(CUR){ const cx=x(CUR.T), cy=y(CUR.S); ctx.fillStyle='#0ea5e9'; ctx.beginPath(); ctx.arc(cx,cy,5,0,2*Math.PI); ctx.fill(); ctx.strokeStyle='#0369a1'; ctx.lineWidth=1; ctx.stroke(); }
    }
    function drawArrow(x1,y1,x2,y2,color){ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); const a=Math.atan2(y2-y1,x2-x1), h=8; ctx.beginPath(); ctx.moveTo(x2,y2); ctx.lineTo(x2-h*Math.cos(a-Math.PI/6),y2-h*Math.sin(a-Math.PI/6)); ctx.lineTo(x2-h*Math.cos(a+Math.PI/6),y2-h*Math.sin(a+Math.PI/6)); ctx.closePath(); ctx.fillStyle=color; ctx.fill(); }

    // === animação ===
    function stepCycle(dt){ if(!S) return; const period=8000; tAnim=(tAnim+dt)%period; const ph=tAnim/period; const segDur=0.25; const idx=Math.floor(ph/segDur); const f=(ph-idx*segDur)/segDur; const seg=['12','23','34','41'][idx]; positionPiston(seg,f); CUR=getSTPoint(seg,f); updateLabels(seg); drawST(); }
    function loop(ts){ if(!playing) return; const dt=(lastTime?ts-lastTime:16.7); lastTime=ts; stepCycle(dt); requestAnimationFrame(loop); }

    btnPlay.addEventListener('click',()=>{ if(playing) return; playing=true; lastTime=0; requestAnimationFrame(loop); });
    btnPause.addEventListener('click',()=>{ playing=false; });
    btnStep.addEventListener('click',()=>{ stepCycle(8000/25); });

    function getSTPoint(seg,f){ if(!S) return null; const {TH,TC,S1,S2}=S; if(seg==='12') return {T:TH, S:S1+f*(S2-S1)}; if(seg==='23') return {T:TH+f*(TC-TH), S:S2}; if(seg==='34') return {T:TC, S:S2+f*(S1-S2)}; if(seg==='41') return {T:TC+f*(TH-TC), S:S1}; return {T:TH,S:S1}; }

    // eventos
    const onChange=()=>compute();
    recalcBtn.addEventListener('click', onChange);
    ;[nEl,THEl,TCEl,V1El,rEl,gEl].forEach(el=> el.addEventListener('input', onChange));

    // start
    compute();
    window.addEventListener('resize', drawST);
  </script>
</body>
</html>
